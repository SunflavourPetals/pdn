# PDN 参考

## 概要

PDN（全称 Petals Data Notation）是 SunflavourPetals（github 用户名）设计的基于 Unicode 的数据交换格式。  

PDN 的特点是：  

1. 尽可能靠近 C++ 字面量的格式；  
2. 可以对数据的类型进行一定程度的控制，并提供检查；  
3. 提供灵活的标识符格式。  

## 正文

### 注释

PDN 解析器将忽略注释内容，注释是为了阅读 PDN 文件的人准备的。  
在特定情况下，注释是有用的，比如使用 PDN 作为程序的一部分配置文件时。  
注释的形式有三种：  

1. 行注释：标记 `//` 至当前行的行尾或文件尾的内容是注释文本；  
2. 块注释：标记 `/*` 至标记 `*/` 的内容是块注释文本；  
3. 可嵌套行注释：标记 `</` 至标记 `/>` 的内容是可嵌套块注释文本，`/>` 只能关闭它前面距离最近的那一层注释。  

```pdn
// 这是行注释
/*
    这是块注释
*/
</
    这是可嵌套块注释(第一层) </ 第二层 /> 第一层
    第一层 </ 第二层 </ 第三层 /> 第二层 /> 第一层
/>
```

建议：块注释和可嵌套块注释具有一定危险性，尤其是后者，请谨慎使用。  

### 数据类型

PDN 的数据有如下 15 种类型：  

1. i8
2. i16
3. i32
4. i64
5. u8
6. u16
7. u32
8. u64
9. f32
10. f64
11. boolean
12. character
13. string
14. list
15. object

list 是列表，其元素类型不限；  
object 为对象(标识符-数据的映射结构)，其直接成员数据不能同名。  

其他标识类型的名字只能是如上类型的别名。  
标准规定了如下别名：  

1. int  
2. uint  

`a` 属于集合 `{ i8, i16, i32, i64 }`(集合中的每个类型大小互不相等)，如果 `int` 与 `a` 大小相同，那么 `int = a`，否则 `int = i32`。  
`b` 属于集合 `{ u8, u16, u32, u64 }`(集合中的每个类型大小互不相等)，如果 `unsigned int` 与 `b` 大小相同，那么 `uint = b`，否则 `uint = u32`。  

PDN 文件解析的结果即是一个 `Object` 类型的数据。  

### 数据定义语法

数据定义语法：  

1. `<标识符-数据名称> <表达式>`  
2. `<标识符-数据名称> : <表达式>`  
3. `<标识符-数据名称> : <标识符-类型名称> <表达式>`  

数据定义结束，可尾随任意数量个分号 `;` 作为间隔符。  

第三条，解析完表达式后，将它的值隐式转换为目标类型，如果发生溢出错误或无法进行转换，该名称指代的数据损坏，将报告错误。  

转换规则：  

1. `i8`、`i16`、`i32`、`i64`、`u8`、`u16`、`u32`、`u64` 在不发生溢出的情况下可以相互转换、可以转换为 `f32`、`f64`、`boolean`；  
2. `f32`、`f64` 可以相互转换、可以转换为 `boolean`；  
3. `boolean` 可以转换为 `i8`、`i16`、`i32`、`i64`、`u8`、`u16`、`u32`、`u64`、`f32`、`f64`。  

对整数和浮点数有一元运算符 `+`，对有符号整数和浮点数有 一元运算符 `-`。  

示例：  

```pdn
list [1, +2, -3, ++4, +-+-5, f32:0xff, ["abc", "mn", string:"xyz"] ]
```

#### List 表达式

List 表达式语法：  

`[ <元素序列> ]`  

`<元素序列>` 为零至多个元素声明，两个相邻元素必须由一个逗号 `,` 隔开，末尾元素可尾随一个逗号(可选)。  

##### List 元素声明

List 元素声明语法：  

1. `<表达式>`  
2. `<标识符-类型名称> : <表达式>`  

第二条的标识符用于转换表达式的类型。  

示例：  

```pdn
list [1, 2, 3, f32:0xff, ["abc", "mn", string:"xyz"] ]
```

#### Object 表达式

List 表达式语法：  

`{ <成员数据序列> }`  

`<成员数据序列>` 即零至多条[数据定义](#数据定义语法)。  

示例：  

```pdn
object { data1:f64 123; data2:f32 456; list[1, 2, 3] }
```

### 标识符

标识符可以作为数据或类型的名称，形式有三种：  

1. 普通标识符；  
2. 字符串标识符；  
3. 原始字符串标识符。  

#### 普通标识符

普通标识符的词法与摘录的 MSVC 的 C++ 标识符相同。  
标识符示例：  

```pdn
identifier
标识符
識別子
iden1234_1234
名字0
_1
```

PDN 对标识符的定义参考了 MSVC 的 C++ 标识符文档。  
[参考 MSDN](https://learn.microsoft.com/zh-cn/cpp/cpp/identifiers-cpp "zh-cn")  
[摘录 MSDN](#摘录-msdn-cpp-标识符)  

#### 字符串标识符

字符串标识符是由一对反引号 `` ` `` 包含的字符串形式的标识符，  
支持转义字符，不可包含换行符 LF、非转义序列的反引号 `` ` `` 和非转义序列的反斜杠 `\`。
字符串标识符示例：  

```pdn
`123456`
`this is an identifier\n`
`iden` // 等价于 iden
```

特殊案例：  

```pdn
`123
456`
// 当使用 CR 作为换行符时，它合法，等价于 `123\r456`，
// 使用 LS(U+2028) 或 PS(U+2029) 作为换行符时，它同样合法，
// 当使用 CRLF 或 LF 作为换行符时，它非法，因为字符串中含有换行符 LF。
```

#### 原始标识符字符串

原始字符串标识符是原始字符串形式的标识符，  
形式为：  

```pdn
@`d_seq(r_seq)d_seq`
```

`d_seq` 为一个或多个[基本字符集(C++26)](https://zh.cppreference.com/w/cpp/language/charset#.E5.9F.BA.E6.9C.AC.E5.AD.97.E7.AC.A6.E9.9B.86)中的字符，不包括括号、反斜杠和空格，最多十六个。  

`r_seq` 为一个或多个[翻译字符集](https://zh.cppreference.com/w/cpp/language/charset)中的字符，不得包含闭序列 `` )d_seq` ``。  

原始字符串的内容即为 `r_seq` 中的内容。  

原始字符串标识符示例：  

```pdn
@`(123456)` // 等价于 `123456`
@`1234abcdABCD(标识符)1234abcdABCD` // 等价于 标识符
@`(C:\Users\)` // 等价于 `C:\\Users\\`
```

特殊情况：当使用 CRLF 作为换行符时，即若 CRLF 出现在原始字符串或原始字符串标识符的内容中时，它被转换成 LF。  

### 字面量

#### 整数字面量

PDN 的整数字面量无任何后缀，其余词法与 C++ 整数字面量一致。  
整数字面量持有的类型从以下类型中根据是否能表示该值依次选择：  
`int`、`i8`、`i16`、`i32`、`i64`、`u64`。  
`int` 由用户使用的平台/编译器根据 C++ `int` 类型的大小自动选择，  
其策略是：  
`a` 属于集合 `{ i8, i16, i32, i64 }`(集合中的每个类型大小互不相等)，如果 `int` 与 `a` 大小相同，那么 `int = a`，否则 `int = i32`。  

整数字面量示例：  

```pdn
// 十进制
0
1
123'456'789

// 二进制
0b1111'0000
0B0

// 十六进制
0xffff'0000
0x0000'FFFF
0XFf'Ee'Dd'Cc
0xaA'bB'cC'Dd

// 八进制
0777
01'234'567
```

[参考 C++ Reference](https://zh.cppreference.com/w/cpp/language/integer_literal)  

#### 浮点数字面量

PDN 的浮点字面量无任何后缀，其余词法与 C++ 整数字面量一致。  
浮点字面量示例：  

```pdn
0.
.0
3.14
1.25e2     // 125
1e-2       // 0.01
123'456.0
0xff'ffp-2 // 16383.75
0x1.p1     // 2
0x.8p1     // 1
```

[参考 C++ Reference](https://zh.cppreference.com/w/cpp/language/floating_literal)  

#### 字符字面量

PDN 的字符字面量是由一对单引号 `'` 包围一个“字符”，  
其“字符”可以是翻译字符集除换行符 LF、反斜杠 `\`、单引号 `'` 的字符或转义字符，  
转义字符必须是一个 Unicode 标量值。  

字符字面量示例：  

```pdn
'c'
'字'
'\x{2028}' // U+2028 LS
```

[转义字符小节](#转义)  

#### 字符串字面量

##### 普通字符串

PDN 的字符串无任何前缀如 `u8`、`u`、`U`、`L`，pdn 解析器使用哪种 utf 编码和编写 pdn 文件的用户无关。  
其余与 C++ 的非原始字符串的字符串词法相同。  
字符串字面量示例：  

```pdn
"Hello, world!"
"你好，世界！"
"123\n\t456\0xyz"
```

[参考 C++ Reference](https://zh.cppreference.com/w/cpp/language/string_literal)  

##### 原始字符串

PDN 的原始字符串无任何前缀如 `u8`、`u`、`U`、`L`，pdn 解析器使用哪种 utf 编码和编写 pdn 文件的用户无关。  
PDN 使用 `@` 代替了 C++ 原始字符串的前缀 `R`，其余与 C++ 的原始字符串的词法相同。  
原始字符串字面量示例：  

```pdn
@"(Hello, world!)"
@"RawStrDS(你好，世界！)RawStrDS"
@"(C:\Users\)" // 等价于 "C:\\Users\\"
```

[参考 C++ Reference](https://zh.cppreference.com/w/cpp/language/string_literal)  

### 转义

PDN 支持 C++ 的转义序列(除了条件转义序列)和通用字符名。  
实现的 PDN 解析器不支持通用字符名 `\N{NAME}`。  

1. 简单转义序列：如 `\a`、`\t`、`\n` 等  
2. `\n*` 其中 `n*` 为一至三位八进制数: 如 `\0`、`\101` 等  
3. `\o{n*}` 其中 `n*` 为一至多位八进制数  
4. `\xn*` 其中 `n*` 为一至多位十六进制数  
5. `\x{n*}` 其中 `n*` 为一至多位十六进制数  
6. `\unnnn` 其中 `nnnn` 为四位十六进制数  
7. `\u{n*}` 其中 `n*` 为一至多位十六进制数  
8. `\Unnnnnnnn` 其中 `nnnnnnnn` 为八位十六进制数  
9. `\N{NAME}` 以 `NAME` 命名的字符(本实现不支持)  

[参考 C++ Reference](https://zh.cppreference.com/w/cpp/language/escape)  

### At标识符

At 标识符的词法为 `@` 紧跟着[普通标识符](#普通标识符)，其值由 PDN 解析器的常量表提供，值的类型可以为整数、浮点数、布尔值、字符或字符串。  

至少提供以下 At 标识符：  

1. `@true` 类型：`boolean`，值：`true`  
2. `@false` 类型：`boolean`，值：`false`  

## 摘录

### 摘录-MSDN

#### 摘录-MSDN-CPP-标识符

允许将以下字符用作标识符的任意字符：  

```cpp
_ a b c d e f g h i j k l m
  n o p q r s t u v w x y z
  A B C D E F G H I J K L M
  N O P Q R S T U V W X Y Z
```

允许将以下 Unicode 码位数字范围用作标识符中的任意字符：  

00A8、00AA、00AD、00AF、00B2-00B5、00B7-00BA、00BC-00BE、00C0-00D6、00D8-00F6、00F8-00FF、0100-02FF、0370-167F、1681-180D、180F-1DBF、1E00-1FFF、200B-200D、202A-202E、203F-2040、2054、2060-206F、2070-20CF、2100-218F、2460-24FF、2776-2793、2C00-2DFF、2E80-2FFF、3004-3007、3021-302F、3031-303F、3040-D7FF、F900-FD3D、FD40-FDCF、FDF0-FE1F、FE30-FE44、FE47-FFFD、10000-1FFFD、20000-2FFFD、30000-3FFFD、40000-4FFFD、50000-5FFFD、60000-6FFFD、70000-7FFFD、80000-8FFFD、90000-9FFFD、A0000-AFFFD、B0000-BFFFD、C0000-CFFFD、D0000-DFFFD、E0000-EFFFD  

允许将以下字符用作标识符中除第一个字符以外的任意字符：  

```cpp
  0 1 2 3 4 5 6 7 8 9
```

还允许将以下 Unicode 码位数字范围用作标识符中除第一个字符以外的任意字符：  
0300-036F、1DC0-1DFF、20D0-20FF、FE20-FE2F  
